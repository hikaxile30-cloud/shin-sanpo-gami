<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>真さんぽ神</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#8B1E1E">
  <style>
    :root{
      --bg:#f6f1e3; --paper:#fffaf0; --ink:#1a1a1a;
      --accent:#8B1E1E; --gold:#c9a227;
      --shadow:0 10px 30px rgba(0,0,0,.12);
      --radius:18px;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(201,162,39,.25), transparent 55%),
                  radial-gradient(900px 500px at 100% 0%, rgba(139,30,30,.18), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(246,241,227,.92), rgba(246,241,227,.60));
      border-bottom:1px solid rgba(0,0,0,.06);
      padding:14px 16px 10px;
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .appTitle{
      font-weight:800; letter-spacing:.08em;
      display:flex; align-items:baseline; gap:10px;
    }
    .appTitle .name{font-size:18px}
    .appTitle .sub{font-size:12px; color:rgba(0,0,0,.55)}
    .pill{
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.65);
      padding:8px 10px; border-radius:999px;
      font-size:12px;
    }

    main{max-width:720px; margin:0 auto; padding:16px 16px 96px;}
    .tabs{display:flex; gap:10px; margin:12px 0 10px;}
    .tab{
      flex:1; text-align:center; padding:10px 12px;
      border-radius:999px; border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.55); cursor:pointer; user-select:none;
      font-weight:700;
    }
    .tab.active{background:rgba(139,30,30,.10); border-color: rgba(139,30,30,.25); color:var(--accent)}
    .panel{display:none}
    .panel.active{display:block}

    .card{
      background: linear-gradient(180deg, rgba(255,250,240,.95), rgba(255,255,255,.85));
      border:1px solid rgba(0,0,0,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 140px at 10% 0%, rgba(201,162,39,.22), transparent 55%),
                  radial-gradient(500px 140px at 90% 10%, rgba(139,30,30,.16), transparent 55%);
      pointer-events:none;
    }
    .cardInner{position:relative}
    .oracle{
      font-weight:800; letter-spacing:.06em;
      color:rgba(0,0,0,.75);
      margin:0 0 6px;
    }
    .oracleHint{margin:0 0 12px; color:rgba(0,0,0,.55); font-size:13px}
    .result{
      white-space:pre-wrap;
      font-size:18px;
      line-height:1.5;
      padding:14px 14px;
      border-radius:14px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.08);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      transform: translateY(8px);
      opacity:.0;
    }
    .result.show{transform: translateY(0); opacity:1}
    .result.glow{box-shadow:0 0 0 3px rgba(201,162,39,.20), 0 14px 34px rgba(0,0,0,.16)}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .chip{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.70);
    }
    .chip.red{border-color: rgba(139,30,30,.25); background: rgba(139,30,30,.08); color: var(--accent)}
    .chip.gold{border-color: rgba(201,162,39,.30); background: rgba(201,162,39,.10)}
    .btnRow{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    button{
      appearance:none; border:0; cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      letter-spacing:.04em;
      transition: transform .08s ease, filter .15s ease;
    }
    button:active{transform: scale(.98)}
    .btnPrimary{background: linear-gradient(180deg, #9b2424, #7f1a1a); color:#fff}
    .btnGhost{background: rgba(255,255,255,.70); border:1px solid rgba(0,0,0,.10)}
    .btnGold{background: linear-gradient(180deg, #d8b34a, #bf9b2b); color:#2a1f00}

    .listCard{margin-top:12px}
    ul{list-style:none; padding:0; margin:10px 0 0}
    .item{
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      border-radius:14px;
      padding:12px 12px;
      margin-bottom:10px;
    }
    .meta{margin-top:6px; font-size:12px; color:rgba(0,0,0,.60)}
    .toast{
      position:fixed; left:50%; bottom:86px; transform:translateX(-50%);
      background:rgba(0,0,0,.78); color:#fff;
      padding:10px 12px; border-radius:999px;
      font-weight:700; font-size:13px;
      opacity:0; pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      z-index:50;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
    .bottomNav{
      position:fixed; left:0; right:0; bottom:0;
      background: rgba(246,241,227,.92);
      border-top:1px solid rgba(0,0,0,.08);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      display:flex; gap:10px; justify-content:center;
      z-index:20;
      backdrop-filter: blur(10px);
    }
    .navBtn{
      flex:1; max-width:220px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      padding:10px 12px;
      font-weight:800;
    }
    .bigText .result{font-size:26px}
    .bigText .chip{font-size:14px}
    /* confetti */
    .confetti{
      position:fixed; inset:-10px 0 auto 0;
      pointer-events:none; z-index:60;
    }
    .confetti i{
      position:absolute; top:-20px;
      width:10px; height:16px; border-radius:3px;
      opacity:.95;
      animation: fall 1100ms linear forwards;
      transform: rotate(0deg);
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(720deg); opacity:0.9; }
    }
  </style>
</head>

<body>
<header>
  <div class="titleRow">
    <div class="appTitle">
      <div class="name">真さんぽ神</div>
      <div class="sub">WHERE × WHAT</div>
    </div>
    <div class="pill" id="ratioPill">電車30% / バス15% / 検索50%</div>
  </div>

  <div class="tabs">
    <div class="tab active" id="tabNow">お題</div>
    <div class="tab" id="tabHistory">履歴</div>
  </div>
</header>

<main>
  <section class="panel active" id="panelNow">
    <div class="card">
      <div class="cardInner">
        <p class="oracle" id="oracleLine">よし。今日の散歩、引いてみるか。</p>
        <p class="oracleHint" id="oracleHint">「お題を引く」で神託が降りる</p>

        <div class="result show" id="result">まだお題がありません。「お題を引く」を押してください。</div>
        <div class="chips" id="chips"></div>

        <div class="btnRow">
          <button class="btnPrimary" id="btnRoll">お題を引く</button>
          <button class="btnGold" id="btnReroll">引き直す</button>
          <button class="btnGhost" id="btnBig">デカ文字</button>
        </div>

        <p class="oracleHint" style="margin-top:14px">
          地図は使いません。必要ならGoogleマップ等で自分で検索してOK。<br>
          電車系30%／バス15%／検索あり50%寄せ／銭湯はたまに（連続しにくい）
        </p>
      </div>
    </div>
  </section>

  <section class="panel" id="panelHistory">
    <div class="card listCard">
      <div class="cardInner">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div>
            <div style="font-weight:900; letter-spacing:.06em">履歴（直近20件）</div>
            <div class="oracleHint" id="historyHint">保存: 0件</div>
          </div>
          <button class="btnGhost" id="btnClear">履歴クリア</button>
        </div>
        <ul id="historyList"></ul>
      </div>
    </div>
  </section>
</main>

<div class="bottomNav">
  <button class="navBtn" id="navRoll">お題を引く</button>
  <button class="navBtn" id="navToHistory">履歴を見る</button>
</div>

<div class="toast" id="toast">OK</div>

<script>
(function registerSW(){
  if (!("serviceWorker" in navigator)) return;
  window.addEventListener("load", async () => {
    try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
  });
})();

const TRAIN_RATIO = 0.30;
const BUS_RATIO   = 0.15; // ← 0.15 ON
const NEED_SEARCH_TARGET = 0.50;
const HISTORY_MAX = 20;
const KEY_HISTORY = "ssg_history_v2_json";
const KEY_BIG = "ssg_bigtext_v1";

/* ===== utils ===== */
const rng = (n) => Math.floor(Math.random() * n);
const pickOne = (arr) => arr[rng(arr.length)];
const $ = (id) => document.getElementById(id);

function loadHistory(){
  try{ return JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]"); }catch(e){ return []; }
}
function saveHistory(list){
  localStorage.setItem(KEY_HISTORY, JSON.stringify(list.slice(0, HISTORY_MAX)));
}
function loadBig(){ return localStorage.getItem(KEY_BIG) === "1"; }
function saveBig(on){ localStorage.setItem(KEY_BIG, on ? "1":"0"); }

function recentNeedSearchRatio(hist){
  const h = (hist||[]).slice(0, 20);
  if(!h.length) return 0.5;
  const t = h.filter(x => x && x.what_need_search).length;
  return t / h.length;
}
function recentHasHigh(hist){
  const h = (hist||[]).slice(0, 10);
  return h.some(x => x && x.what_time_risk === "high");
}
function diffCounts(hist){
  const h = (hist||[]).slice(0, 20);
  const m = new Map();
  for(const e of h){
    const d = e?.what_difficulty;
    if(typeof d === "number") m.set(d, (m.get(d)||0)+1);
  }
  return m;
}

/* ===== confetti ===== */
function confettiBurst(){
  const wrap = document.createElement("div");
  wrap.className = "confetti";
  const colors = ["#c9a227","#8b1e1e","#ffffff","#1a1a1a","#f0d9a0"];
  const n = 22;
  for(let i=0;i<n;i++){
    const el = document.createElement("i");
    const x = Math.random() * 100;
    el.style.left = x + "vw";
    el.style.background = colors[rng(colors.length)];
    el.style.animationDuration = (900 + Math.random()*700) + "ms";
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    el.style.opacity = (0.75 + Math.random()*0.25).toFixed(2);
    el.style.width = (8 + Math.random()*6) + "px";
    el.style.height = (10 + Math.random()*10) + "px";
    wrap.appendChild(el);
  }
  document.body.appendChild(wrap);
  setTimeout(()=> wrap.remove(), 1600);
}

/* ===== UI ===== */
const $result = $("result");
const $chips = $("chips");
const $historyList = $("historyList");
const $historyHint = $("historyHint");
const $oracleLine = $("oracleLine");
const $oracleHint = $("oracleHint");
const $toast = $("toast");
const $tabNow = $("tabNow");
const $tabHistory = $("tabHistory");
const $panelNow = $("panelNow");
const $panelHistory = $("panelHistory");
const $btnBig = $("btnBig");

let history = loadHistory();

function toast(msg){
  $toast.textContent = msg;
  $toast.classList.add("show");
  setTimeout(()=> $toast.classList.remove("show"), 900);
}
function setTab(which){
  const now = which === "now";
  $tabNow.classList.toggle("active", now);
  $tabHistory.classList.toggle("active", !now);
  $panelNow.classList.toggle("active", now);
  $panelHistory.classList.toggle("active", !now);
}
function renderChips(where, what){
  const chips = [
    {t: where.isTrain ? "電車" : (where.isBus ? "バス" : "徒歩"), cls: where.isTrain ? "red" : "gold"},
    {t: what.needSearch ? "検索あり" : "検索なし", cls: what.needSearch ? "red" : ""},
    {t: "難易度 " + what.difficulty, cls: ""},
    {t: "リスク " + (what.timeRisk||"low"), cls: ""}
  ];
  $chips.innerHTML = chips.map(c => `<span class="chip ${c.cls||""}">${c.t}</span>`).join("");
}
function renderHistory(){
  const list = history.slice(0, HISTORY_MAX);
  $historyHint.textContent = `保存: ${list.length}件`;
  $historyList.innerHTML = "";
  for(const e of list){
    const li = document.createElement("li");
    li.className = "item";
    const title = document.createElement("div");
    title.textContent = `${e.where_text}\n→ ${e.what_text}`;
    title.style.whiteSpace = "pre-wrap";
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `検索:${e.what_need_search?"あり":"なし"} / 難易度:${e.what_difficulty} / 電車:${e.where_is_train?"あり":"なし"} / リスク:${e.what_time_risk} / ${new Date(e.created_at).toLocaleString()}`;
    li.appendChild(title);
    li.appendChild(meta);
    $historyList.appendChild(li);
  }
}
function oracleSay(line, hint){
  $oracleLine.textContent = line;
  $oracleHint.textContent = hint || "";
}
function revealResult(){
  $result.classList.remove("show");
  requestAnimationFrame(()=> requestAnimationFrame(()=> $result.classList.add("show")));
}
function flashResult(){
  $result.classList.add("glow");
  setTimeout(()=> $result.classList.remove("glow"), 420);
}

/* ===== data load (JSON) ===== */
let WHERE = [];
let WHAT = [];

async function loadData(){
  const [w1,w2] = await Promise.all([
    fetch("./where.json", {cache:"no-store"}).then(r => r.json()),
    fetch("./what.json", {cache:"no-store"}).then(r => r.json()),
  ]);
  WHERE = w1;
  WHAT  = w2;
}

/* ===== pickers ===== */
function isBusWhere(w){
  const s = (w.id||"") + " " + (w.text||"");
  return /\bbus\b/i.test(s) || s.includes("バス");
}

function pickWhere(hist){
  const base = WHERE.map(w => ({...w, isBus: !w.isTrain && isBusWhere(w)}));
  const trainPool = base.filter(w => w.isTrain);
  const busPool   = base.filter(w => w.isBus);
  const walkPool  = base.filter(w => !w.isTrain && !w.isBus);

  const r = Math.random();
  if(trainPool.length && r < TRAIN_RATIO) return pickOne(trainPool);

  const busGate = TRAIN_RATIO + BUS_RATIO;
  if(busPool.length && r < busGate) return pickOne(busPool);

  if(walkPool.length) return pickOne(walkPool);
  const nonTrain = base.filter(w => !w.isTrain);
  return pickOne(nonTrain.length ? nonTrain : base);
}

function pickWhat(hist){
  const h = Array.isArray(hist) ? hist : [];
  const EXCLUDE_N = 20;

  const ban20 = new Set(h.slice(0, EXCLUDE_N).map(x => x?.what_id).filter(Boolean));

  const r = recentNeedSearchRatio(h);
  const wantNeedSearch = (r < NEED_SEARCH_TARGET);

  let pool = WHAT.filter(w => w.needSearch === wantNeedSearch && !ban20.has(w.id));
  if(pool.length < 8) pool = WHAT.filter(w => !ban20.has(w.id));

  // A救済: 候補0の時だけ15に緩める
  if(pool.length === 0){
    const ban15 = new Set(h.slice(0, 15).map(x => x?.what_id).filter(Boolean));
    pool = WHAT.filter(w => !ban15.has(w.id));
  }
  if(pool.length === 0) pool = WHAT.slice();

  if(recentHasHigh(h)){
    const filtered = pool.filter(w => (w.timeRisk||"low") !== "high");
    if(filtered.length) pool = filtered;
  }

  const counts = diffCounts(h);
  const sorted = pool.slice().sort((a,b) => (counts.get(a.difficulty)||0) - (counts.get(b.difficulty)||0));
  const topK = sorted.slice(0, Math.min(10, sorted.length));
  return pickOne(topK);
}

function roll(kind){
  const where = pickWhere(history);
  const what  = pickWhat(history);

  $result.textContent = `${where.text}\n→ ${what.text}`;
  renderChips(where, what);
  revealResult();
  flashResult();

  const item = {
    where_id: where.id,
    where_text: where.text,
    where_is_train: !!where.isTrain,

    what_id: what.id,
    what_text: what.text,
    what_need_search: !!what.needSearch,
    what_difficulty: what.difficulty,
    what_time_risk: what.timeRisk || "low",

    created_at: new Date().toISOString()
  };

  history.unshift(item);
  history = history.slice(0, HISTORY_MAX);
  saveHistory(history);
  renderHistory();

  const lines = ["よし。神託が降りた。","迷うな。これが縁だ。","今日はこれでいけ。","運命の散歩、始めよ。","ふむ…これで良い。","……知らんけど。"];
  const hints = [
    what.needSearch ? "必要なら検索してよい" : "今日は検索なしでよい",
    where.isTrain ? "電車を使ってよい" : (where.isBus ? "バスを使ってよい" : "徒歩でよい"),
    (what.timeRisk === "high") ? "無理はするな（外観だけでも可）" : "気軽に行け"
  ];
  oracleSay(pickOne(lines), pickOne(hints));
  toast(kind === "reroll" ? "引き直し" : "神託！");
  confettiBurst();
  setTab("now");
}

function setBig(on){
  document.body.classList.toggle("bigText", on);
  $btnBig.textContent = on ? "デカ文字ON" : "デカ文字";
  saveBig(on);
  toast(on ? "デカ文字ON" : "デカ文字OFF");
}

/* ===== events ===== */
$("btnRoll").addEventListener("click", () => roll("roll"));
$("btnReroll").addEventListener("click", () => roll("reroll"));
$("navRoll").addEventListener("click", () => roll("roll"));
$("navToHistory").addEventListener("click", () => setTab("history"));
$tabNow.addEventListener("click", () => setTab("now"));
$tabHistory.addEventListener("click", () => setTab("history"));

$("btnClear").addEventListener("click", () => {
  if(!confirm("履歴を全削除します。よろしいですか？")) return;
  history = [];
  saveHistory(history);
  renderHistory();
  $result.textContent = "履歴を削除しました。「お題を引く」を押してください。";
  $chips.innerHTML = "";
  oracleSay("清めた。", "また引け");
  revealResult();
  toast("削除");
});

$btnBig.addEventListener("click", () => setBig(!document.body.classList.contains("bigText")));

/* ===== init ===== */
(async function init(){
  try{
    await loadData();
    oracleSay("よし。今日の散歩、引いてみるか。", "「お題を引く」で神託が降りる");
    renderHistory();
    setTab("now");
    setBig(loadBig());
  }catch(e){
    $result.textContent = "データ読み込みに失敗しました。where.json / what.json の設置を確認してください。";
    oracleSay("……神託が届かない。", "where.json / what.json を確認");
    console.error(e);
  }
})();
</script>
</body>
</html>
