  ];
  $chips.innerHTML = chips.map(c => `<span class="chip ${c.red ? "red":""}">${c.t}</span>`).join("");
}
function renderHistory(){
  const list = history.slice(0, HISTORY_MAX);
  $historyHint.textContent = `保存: ${list.length}件`;
  $historyList.innerHTML = "";
  for(const e of list){
    const li = document.createElement("li");
    li.className = "item";
    const title = document.createElement("div");
    title.textContent = `${e.where_text}\n→ ${e.what_text}`;
    title.style.whiteSpace = "pre-wrap";

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <span>検索:${e.what_need_search ? "あり" : "なし"}</span>
      <span>難易度:${e.what_difficulty}</span>
      <span>電車:${e.where_is_train ? "あり" : "なし"}</span>
      <span>リスク:${e.what_time_risk}</span>
    `;
    li.appendChild(title);
    li.appendChild(meta);
    $historyList.appendChild(li);
  }
}
function oracleSay(line, hint){
  $oracleLine.textContent = line;
  $oracleHint.textContent = hint || "";
}
function revealResult(){
  $result.classList.remove("show");
  $result.classList.add("reveal");
  requestAnimationFrame(() => requestAnimationFrame(() => $result.classList.add("show")));
}
function flashResult(){
  $result.classList.add("glow");
  setTimeout(() => $result.classList.remove("glow"), 420);
}

/* ========= DATA ARRAYS WILL BE IN PART 2/3 and 3/3 ========= */
  {id:"w_toward_quiet_10", text:"人が少なそうな方へ10分歩いて", isTrain:false, difficulty:2},

  {id:"w_straight_until_deadend", text:"なるべく曲がらず、行き止まりか大きい道に当たるまで歩いて（最大15分）", isTrain:false, difficulty:3},
  {id:"w_find_bridge_then_start", text:"橋か踏切を見つけるまで歩いて、見つけた場所から始めて", isTrain:false, difficulty:3},
  {id:"w_find_bench_then_start", text:"ベンチを1つ見つけるまで歩いて、見つけた場所から始めて", isTrain:false, difficulty:2},
  {id:"w_find_vending_then_10", text:"自販機を1台見つけたら、そこから10分歩いて", isTrain:false, difficulty:2},
  {id:"w_find_red_then_10", text:"赤いものを見つけたら、そこから10分歩いて", isTrain:false, difficulty:3},
  {id:"w_find_blue_then_10", text:"青いものを見つけたら、そこから10分歩いて", isTrain:false, difficulty:3},
  {id:"w_find_tall_building_10", text:"背の高い建物が見える方へ10分歩いて", isTrain:false, difficulty:2},
  {id:"w_find_old_sign_10", text:"古そうな看板がある方へ10分歩いて", isTrain:false, difficulty:2},
  {id:"w_find_new_building_10", text:"新しそうな建物がある方へ10分歩いて", isTrain:false, difficulty:2},

  /* --- rules / playful (約45) --- */
  {id:"w_rule_no_right_10", text:"右折禁止で10分歩いて（左か直進だけ）", isTrain:false, difficulty:3},
  {id:"w_rule_no_left_10", text:"左折禁止で10分歩いて（右か直進だけ）", isTrain:false, difficulty:3},
  {id:"w_rule_only_right_12", text:"12分間、右に曲がれる時は右を優先して歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_only_left_12", text:"12分間、左に曲がれる時は左を優先して歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_coinflip_10", text:"角が出るたびにコイントス（表=右/裏=左）で10分歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_turn_every_3min", text:"3分歩くたびに、次の角で必ず曲がって10〜12分歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_one_alley_required", text:"路地に1回だけ入ってから、元の道に戻って8分歩いて", isTrain:false, difficulty:3},
  {id:"w_rule_color_hunt_12", text:"最初に見えた“好きな色”を決めて、その色の看板がある方へ12分歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_follow_smell_10", text:"いい匂いがする方向へ10分歩いて（安全な範囲で）", isTrain:false, difficulty:4},
  {id:"w_rule_follow_music_8", text:"音楽が聞こえる方向へ8分歩いて（遠ざかってもOK）", isTrain:false, difficulty:4},
  {id:"w_rule_3rd_corner_turn", text:"3つ目の角で必ず曲がって、そのまま10分歩いて", isTrain:false, difficulty:3},
  {id:"w_rule_follow_numbers", text:"数字が書いてある看板（例: 24h）を見つけたら、その方向へ8分歩いて", isTrain:false, difficulty:4},

  {id:"w_out_and_back_10", text:"5分進んで、別ルートで5分戻ってきて", isTrain:false, difficulty:3},
  {id:"w_triangle_walk", text:"三角形を描くつもりで、3回曲がって10〜15分歩いて", isTrain:false, difficulty:4},
  {id:"w_square_walk", text:"四角形を描くつもりで、4回曲がって10〜15分歩いて", isTrain:false, difficulty:4},

  /* --- start points (約20) --- */
  {id:"w_start_station_10", text:"いちばん近い駅（またはバス停）を起点にして10分歩いて", isTrain:false, difficulty:2},
  {id:"w_start_station_12", text:"いちばん近い駅（またはバス停）を起点にして12分歩いて", isTrain:false, difficulty:2},
  {id:"w_start_conbini_10", text:"いちばん近いコンビニを起点にして10分歩いて", isTrain:false, difficulty:2},
  {id:"w_start_conbini_12", text:"いちばん近いコンビニを起点にして12分歩いて", isTrain:false, difficulty:2},
  {id:"w_start_super_10", text:"いちばん近いスーパーを起点にして10分歩いて", isTrain:false, difficulty:2},
  {id:"w_start_park", text:"近くの公園を1つ探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_start_shrine", text:"近くの神社/寺を1つ探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_start_shotengai", text:"近くの商店街を探して、入口っぽい所から始めて", isTrain:false, difficulty:3},
  {id:"w_start_cafe", text:"近くの喫茶店/カフェを探して、店の前から始めて", isTrain:false, difficulty:2},
  {id:"w_start_bookstore", text:"近くの本屋を探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_start_bridge", text:"近くの橋を探して、橋のたもとから始めて", isTrain:false, difficulty:3},
  {id:"w_start_bakery", text:"近くのパン屋を探して、店の前から始めて", isTrain:false, difficulty:2},
  {id:"w_start_wagashi", text:"近くの和菓子屋を探して、店の前から始めて", isTrain:false, difficulty:3},
  {id:"w_start_kissaten_nonchain", text:"近くの喫茶店（チェーン以外優先）を探して、店の前から始めて", isTrain:false, difficulty:3},
  {id:"w_start_sentou_outside", text:"近くの銭湯を探して、外観を見たところから始めて", isTrain:false, difficulty:4},
];/* ========= WHAT (≈200) =========
   方針：検索なし/ありを半々寄せ。飲食/買い物/写真/観察をバランス。
   ユーモア強度2：ごっこ・縛り・心の中ミッション多め（安全）。
*/
const WHAT = [
  /* --- 検索なし (100) 写真・観察・行動・買い物 --- */
  {id:"a_photo_1", text:"気になったものを1枚写真に撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_3", text:"気になったものを3枚写真に撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_5", text:"気になったものを5枚写真に撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_red_3", text:"「赤」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_blue_3", text:"「青」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_green_3", text:"「緑」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_yellow_3", text:"「黄色」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_shadow_3", text:"「影」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_reflection_2", text:"反射（ガラス/水たまり）を狙って写真を2枚撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_reflection_5", text:"反射（ガラス/水たまり/金属）を5つ集めて写真を撮る", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_text_5", text:"文字が入った風景を写真で5枚集める", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_letters_10", text:"文字が写る写真を10枚撮る（看板/注意書きOK）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_round_5", text:"丸いものを5個見つけて写真を撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_square_5", text:"四角いものを5個見つけて写真を撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_triangle_5", text:"三角っぽいものを5個集める（写真OK）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_pattern_5", text:"模様（ドット/ストライプ/格子）を5つ集める（写真OK）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_texture_5", text:"質感（つるつる/ざらざら/木/金属）を5つ集めて写真を撮る", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_door_3", text:"店のドアを3つ撮る（家じゃなく店優先）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_window_3", text:"窓を3つ撮る（反射が写ったら当たり）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_stairs_2", text:"階段を2つ撮る（上から/下からどちらか）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_sign_5", text:"看板を5枚撮る（文字が面白いと加点）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_no_people_1", text:"人が写らない写真を1枚撮る（難しければ遠景で）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_best_1_edit", text:"今日のベスト写真を1枚選んで、軽く編集する", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_same_color_7", text:"同じ色を7個集める（写真でもOK）", needSearch:false, difficulty:2, timeRisk:"mid"},
  {id:"a_photo_gold_3", text:"金色っぽいものを3つ集めて写真を撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_vermilion_white", text:"“朱×白”っぽい写真を1枚撮る（神社感）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_before_after", text:"同じ場所を近い/遠いで2枚撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_lowangle_1", text:"ローアングルで1枚撮る（安全第一）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_highangle_1", text:"少し高い目線で1枚撮る（無理はしない）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_monochrome_3", text:"モノクロっぽく見える写真を3枚撮る", needSearch:false, difficulty:2, timeRisk:"low"},

  {id:"a_observe_cute_sign", text:"今日いちばん“かわいい看板”を決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_strong_shopname", text:"今日いちばん“強そうな店名”を1つ見つける", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_best_smell", text:"今日いちばん“いい匂いがした場所”を1つ決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_best_font", text:"今日いちばん良いフォントの看板を決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_best_slogan", text:"今日いちばん刺さったキャッチコピーを1つメモする", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_observe_mysterious_sign", text:"意味が分からない看板を1つ見つける（写真OK）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_observe_kanji_one", text:"かっこいい漢字を1文字だけ見つける（看板/注意書き）", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_logo_mascot", text:"ゆるキャラっぽいロゴを1つ見つける", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_number_lucky", text:"ゾロ目（11/22/777など）を1回見つけるまで歩く（最大15分）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_observe_animal_3", text:"動物っぽいモチーフ（猫/犬/鳥など）を3つ見つける", needSearch:false, difficulty:2, timeRisk:"low"},

  {id:"a_roleplay_detective", text:"探偵ごっこ：怪しい（面白い）店を1つ“発見”する", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_roleplay_reporter", text:"記者ごっこ：今日の散歩の見出しを1本作る（心の中で）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_roleplay_architect", text:"建築家ごっこ：好きな建物を1つ選んで“推しポイント”を3つ考える", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_roleplay_critic", text:"評論家ごっこ：看板を1つ選んで10点満点で採点する", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_roleplay_narrator", text:"ナレーターごっこ：3分だけ頭の中で実況しながら歩く", needSearch:false, difficulty:3, timeRisk:"mid"},

  {id:"a_walk_no_music_15", text:"15分だけイヤホン無しで歩く", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_walk_silent_5", text:"5分だけ無言で歩いて、音を聞く", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_walk_stop_3", text:"「止まる→見る→進む」を3回だけ丁寧にやる", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_walk_no_phone_10", text:"10分だけスマホを見ないで歩く", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_walk_detour_one", text:"いつもなら行かない道を1本だけ通ってみる（安全な範囲）", needSearch:false, difficulty:2, timeRisk:"mid"},
  {id:"a_walk_steps_300", text:"300歩だけ数えて歩く（数え終わったら通常へ）", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_rest_2min", text:"どこか安全な場所で2分休憩して深呼吸する", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_rest_5min", text:"5分だけ座って休む（可能なら）", needSearch:false, difficulty:1, timeRisk:"low"},

  {id:"a_buy_drink_unusual", text:"自販機で「普段絶対買わない飲み物」を1本買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_snack_unusual", text:"コンビニで「普段買わないお菓子」を1つ買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_new_flavor", text:"普段買わない味のものを1つ買う（飲み物/お菓子OK）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_small_luxury", text:"“ちいさな贅沢”を1つ買う（〜1000円目安）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_buy_mystery_choice", text:"直感で“謎”な商品を1つ選ぶ（買う/買わない自由）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_one_word", text:"パッケージの言葉に惹かれたものを1つ選ぶ（買う/買わない自由）", needSearch:false, difficulty:2, timeRisk:"low"},

  {id:"a_game_shrine_pose", text:"（心の中で）“神社に来たつもり”で背筋を正す瞬間を3回作る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_game_boss_battle", text:"“ボスっぽい建物”を1つ見つけて、勝手にBGMを付ける（心の中）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_game_sidequest", text:"“サブクエスト”を1つ作って達成する（例: 看板1枚撮る）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_game_loot", text:"“戦利品”として写真を1枚だけ持ち帰る（今日の象徴）", needSearch:false, difficulty:2, timeRisk:"low"},

  /* --- 検索あり (100) 飲食・買い物・写真スポット・場所 --- */
  {id:"b_food_nearest_meal", text:"いちばん近い飲食店で食事する（ジャンル自由）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_nearest_cafe", text:"いちばん近いカフェ/喫茶店で1杯飲む", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_sweets", text:"近くで甘いもの（ケーキ/和菓子/アイス）を1つ食べる", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_takeout", text:"近くでテイクアウトを1つ買う（食べるのは後でもOK）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_takeout_park", text:"テイクアウトを買って、公園か広い場所で食べる（無理なら持ち帰り）", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_bakery_1", text:"近くのパン屋を探してパンを1個買う", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_bakery_recommend", text:"近くのパン屋で“おすすめっぽいパン”を1つ買う", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_wagashi_1", text:"近くの和菓子屋を探して和菓子を1個買う", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_kissaten_coffee", text:"近くの喫茶店でコーヒー/紅茶を1杯飲む", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_noodle", text:"近くの麺（そば/うどん/ラーメン等）を食べる（量は軽めでもOK）", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_teishoku_basic", text:"近くのごはん屋で“定番っぽい定食”を食べる", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_teishoku_daily", text:"近くの定食屋で日替わりっぽいものを頼む", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_machichuka_one", text:"近くの町中華で一品だけ食べる（軽めでOK）", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_nonchain_challenge", text:"チェーンじゃない店を1つ探して入る（無理なら外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"mid"},
  {id:"b_food_seasonal", text:"季節限定/期間限定っぽいものを1つ探して食べる（飲み物でもOK）", needSearch:true, difficulty:4, timeRisk:"mid"},

  {id:"b_food_menu_by_vibes", text:"近くの店で“雰囲気だけで”1品選ぶ（無理なら次善でOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_sign_kanban", text:"店頭の看板メニューが一番強い店に入る（無理なら外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"mid"},
  {id:"b_food_drink_color", text:"飲み物を“今日は朱/金/白”のどれかで選ぶ", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_sweets_takeout", text:"甘いものをテイクアウトして“勝利”を味わう", needSearch:true, difficulty:2, timeRisk:"mid"},

  {id:"b_shop_bookstore_cover", text:"近くの本屋で“表紙が刺さる本”を1冊探す（購入自由）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_bookstore_unknown", text:"近くの本屋で「知らない分野」の本を1冊探す（購入は任意）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_book_one_sentence", text:"本屋で“1文だけ”読んで刺さった本をメモ（買わなくてOK）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_zakka", text:"近くの雑貨屋で小さなお土産を探す（購入は任意）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_zakka_small", text:"近くの雑貨屋で“手のひらサイズの物”を探す（買わなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_one_color", text:"雑貨屋で“1色縛り”で小物を探す（買わなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_flowers", text:"近くの花屋で季節の花を1輪探す（購入は任意）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_flower_view", text:"近くの花屋で“季節っぽい花”を眺める（買わなくてOK）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_recycle", text:"近くの古本屋/リサイクルショップに入る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_reuse_walkthrough", text:"近くの古本屋/リサイクルショップに入って1周する（買わなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_weird_stationery", text:"文房具屋/100均で“謎に便利そうな道具”を探す（買わなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},

  {id:"b_photo_park_season", text:"近くの公園へ行って季節っぽい写真を撮る", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_photo_park_green", text:"近くの公園へ行って“緑が多い写真”を1枚撮る", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_photo_water_reflection", text:"近くの川/水辺へ行って反射の写真を撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_bridge_lines", text:"近くの橋へ行って“線”が気持ちいい写真を1枚撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_shrine_gate", text:"近くの神社/寺へ行って入口（鳥居/山門）を撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_underpass_shadow", text:"近くのガード下/高架下へ行って陰影の写真を撮る", needSearch:true, difficulty:4, timeRisk:"mid"},
  {id:"b_photo_shotengai_signs", text:"近くの商店街で“看板”を10枚撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_shotengai_letters", text:"近くの商店街で“文字の写真”を10枚撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_statue", text:"近くの像/オブジェを探して写真を撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_viewpoint", text:"景色が良さそうな場所を探して1枚撮る（遠ければ妥協OK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_old_shopfront", text:"古い店構えっぽい外観を探して撮る（中に入らなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},

  {id:"b_place_shrine_visit", text:"近くの神社/寺に行って手を合わせる（静かに）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_place_park_rest", text:"近くの公園で3分だけ休む", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_place_library_outside", text:"近くの図書館を探して外観を見る（入れるなら入ってOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_place_station_stamp", text:"近くの駅（またはバス停）で“旅気分”になる（スタンプがあれば押す）", needSearch:true, difficulty:3, timeRisk:"mid"},

  {id:"b_sentou_optional", text:"近くの銭湯を探して、入るかどうかは気分で決める（外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"high"},
];
/* ========= CONFIG (bus ON) ========= */
const BUS_RATIO = 0.15; // ← 0.15 ON（バス枠）
/* TRAIN_RATIO は PART1/3 側の const TRAIN_RATIO = 0.30 を使用 */

/* ========= WHAT (例: 200) =========
   ※ここは「すでにあなたのWHAT 200件が用意済み」という前提で、
   もし未投入なら、ここに WHAT 配列（200件）を丸ごと入れてください。
   すでにPART3冒頭に WHAT があるなら、このコメント～WHAT定義を削除してOK。
*/
const WHAT = [
  /* --- 検索なし（ここは例。あなたの200件版に差し替え推奨） --- */
  {id:"a_photo_1", text:"気になったものを1枚写真に撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_best_font", text:"今日いちばん良いフォントの看板を決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_roleplay_detective", text:"探偵ごっこ：怪しい（面白い）店を1つ“発見”する", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_drink_unusual", text:"自販機で「普段絶対買わない飲み物」を1本買う", needSearch:false, difficulty:2, timeRisk:"low"},

  /* --- 検索あり（ここは例。あなたの200件版に差し替え推奨） --- */
  {id:"b_food_nearest_cafe", text:"いちばん近いカフェ/喫茶店で1杯飲む", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_photo_park_season", text:"近くの公園へ行って季節っぽい写真を撮る", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_recycle", text:"近くの古本屋/リサイクルショップに入る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_sentou_optional", text:"近くの銭湯を探して、入るかどうかは気分で決める（外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"high"},
];

/* ========= WHERE分類補助 =========
  isTrain に加えて、id/textに "bus" を含むものをバス扱いにします。
  （PART2/3 のWHEREに bus系idが含まれている前提。例: w_bus_...）
*/
function isBusWhere(w){
  if(!w) return false;
  const s = (w.id || "") + " " + (w.text || "");
  return /\bbus\b/i.test(s) || s.includes("バス");
}

/* ========= pickWhere (train 0.30 / bus 0.15 / rest walk) ========= */
function pickWhere(hist){
  const trainPool = WHERE.filter(w => w.isTrain);
  const busPool   = WHERE.filter(w => !w.isTrain && isBusWhere(w));
  const walkPool  = WHERE.filter(w => !w.isTrain && !isBusWhere(w));

  const r = Math.random();

  // 優先順位: 電車 → バス → 徒歩（比率で分岐）
  if(trainPool.length > 0 && r < TRAIN_RATIO){
    return pickOne(trainPool);
  }

  // trainを外した残り領域で bus を 0.15 ぶん確保
  const busGate = TRAIN_RATIO + BUS_RATIO;
  if(busPool.length > 0 && r < busGate){
    return pickOne(busPool);
  }

  // 残りは徒歩（徒歩が枯れたらnon-train全体）
  if(walkPool.length > 0) return pickOne(walkPool);
  const nonTrainPool = WHERE.filter(w => !w.isTrain);
  return pickOne(nonTrainPool.length ? nonTrainPool : WHERE);
}

/* ========= pickWhat: 直近20件 what_id 完全除外（A救済: 0件時だけ15に緩め） ========= */
function pickWhat(hist){
  const h = Array.isArray(hist) ? hist : [];
  const EXCLUDE_N = 20;

  const ban20 = new Set(h.slice(0, EXCLUDE_N).map(x => x?.what_id).filter(Boolean));

  // needSearch を 50:50 に寄せる（直近比率が低ければ needSearch:true を優先）
  const r = recentNeedSearchRatio(h);
  const wantNeedSearch = (r < NEED_SEARCH_TARGET);

  let pool = WHAT.filter(w => w.needSearch === wantNeedSearch && !ban20.has(w.id));
  if(pool.length < 8){
    pool = WHAT.filter(w => !ban20.has(w.id));
  }

  // A救済: 候補ゼロの時だけ除外を15件に緩める
  if(pool.length === 0){
    const ban15 = new Set(h.slice(0, 15).map(x => x?.what_id).filter(Boolean));
    pool = WHAT.filter(w => !ban15.has(w.id));
  }
  if(pool.length === 0) pool = WHAT.slice();

  // highが続いてるなら high を避ける（残るなら）
  if(recentHasHigh(h)){
    const filtered = pool.filter(w => w.timeRisk !== "high");
    if(filtered.length > 0) pool = filtered;
  }

  // 難易度の偏り抑制（上位10縛りは残す：あなたの現行方針）
  const counts = diffCounts(h);
  const sorted = pool.slice().sort((a,b) => (counts.get(a.difficulty)||0) - (counts.get(b.difficulty)||0));
  const topK = sorted.slice(0, Math.min(10, sorted.length));
  return pickOne(topK);
}

/* ========= roll / events / init ========= */
function roll(kind){
  const where = pickWhere(history);
  const what  = pickWhat(history);

  $result.textContent = `${where.text}\n→ ${what.text}`;
  renderChips(where, what);
  revealResult();
  flashResult();

  const item = {
    where_id: where.id,
    where_text: where.text,
    where_is_train: !!where.isTrain,

    what_id: what.id,
    what_text: what.text,
    what_need_search: !!what.needSearch,
    what_difficulty: what.difficulty,
    what_time_risk: what.timeRisk || "low",

    created_at: new Date().toISOString()
  };

  history.unshift(item);
  history = history.slice(0, HISTORY_MAX);
  saveHistory(history);
  renderHistory();

  const lines = [
    "よし。神託が降りた。",
    "迷うな。これが縁だ。",
    "今日はこれでいけ。",
    "運命の散歩、始めよ。",
    "ふむ…これで良い。",
    "……知らんけど。",
    "これが出たなら、もうやるしかない。"
  ];
  const hints = [
    what.needSearch ? "必要なら検索してよい" : "今日は検索なしでよい",
    where.isTrain ? "電車を使ってよい" : "徒歩（またはバス）でよい",
    (what.timeRisk === "high") ? "無理はするな（外観だけでも可）" : "気軽に行け"
  ];

  oracleSay(pickOne(lines), pickOne(hints));
  toast(kind === "reroll" ? "引き直し" : "神託！");
  confettiBurst();              // 紙吹雪
  setTab("now");
}

function setBig(on){
  document.body.classList.toggle("bigText", on);
  $btnBig.textContent = on ? "デカ文字ON" : "デカ文字";
  saveBig(on);
  toast(on ? "デカ文字ON" : "デカ文字OFF");
}

/* events */
$("btnRoll").addEventListener("click", () => roll("roll"));
$("btnReroll").addEventListener("click", () => roll("reroll"));
$("navRoll").addEventListener("click", () => roll("roll"));
$("navToHistory").addEventListener("click", () => setTab("history"));
$tabNow.addEventListener("click", () => setTab("now"));
$tabHistory.addEventListener("click", () => setTab("history"));

$("btnClear").addEventListener("click", () => {
  if(!confirm("履歴を全削除します。よろしいですか？")) return;
  history = [];
  saveHistory(history);
  renderHistory();
  $result.textContent = "履歴を削除しました。「お題を引く」を押してください。";
  $chips.innerHTML = "";
  oracleSay("清めた。", "また引け");
  revealResult();
  toast("削除");
});

$btnBig.addEventListener("click", () => setBig(!document.body.classList.contains("bigText")));

/* init */
renderHistory();
setTab("now");
setBig(loadBig());

</script>
</body>
</html>
