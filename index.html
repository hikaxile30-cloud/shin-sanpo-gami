<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>真さんぽ神</title>

  <meta name="theme-color" content="#b91c1c" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- readable JP font (free) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap">

  <style>
    :root{
      --paper:#fbfaf7;
      --paper2:#f6f2ea;
      --ink:#1f2937;
      --muted:#6b7280;

      --vermilion:#b91c1c; /* 朱 */
      --vermilion2:#ef4444;
      --gold:#b45309;      /* 金っぽい */
      --line: rgba(31,41,55,.12);

      --card: rgba(255,255,255,.74);
      --shadow: 0 18px 45px rgba(17,24,39,.12);
      --radius: 18px;

      /* でか文字モード：scale倍率（5倍級） */
      --zoom: 1;/* ====== 縦画面いっぱいに埋める修正 ====== */

/* mainが縦いっぱいになるように（header+bottomNavの分だけ引く） */
main{
  min-height: calc(100dvh - 70px - 110px);
  display: flex;
  flex-direction: column;
}

/* panelを“伸びる箱”にする（display:none→flex切替でも崩れない） */
#panelNow, #panelHistory{
  flex: 1 1 auto;
  min-height: 0;               /* overflowが効くために重要 */
  display: flex;
  flex-direction: column;
}

/* お題表示を“残り全部使う” */
#panelNow .result{
  flex: 1 1 auto;
  min-height: 0;
  align-items: flex-start;     /* 中央寄せが嫌なら上寄せ。中央が良ければ center に */
}

/* 履歴リストも“残り全部使う” */
#panelHistory #historyList{<span class="cursor">█</span>/* デカ文字中は min-height 計算を無効化して崩れを減らす */
body.bigText main{
  min-height: auto;
}

    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: "Zen Maru Gothic", system-ui, -apple-system, "Noto Sans JP", sans-serif;

      background:
        radial-gradient(900px 650px at 18% 6%, rgba(185,28,28,.08), transparent 55%),
        radial-gradient(850px 600px at 85% 18%, rgba(180,83,9,.08), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      position: relative;
    }

    /* washi fibers (CSS only) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .25;
      background:
        repeating-linear-gradient( 12deg,
          rgba(31,41,55,.04) 0px,
          rgba(31,41,55,.04) 1px,
          transparent 1px,
          transparent 6px
        ),
        repeating-linear-gradient(-12deg,
          rgba(31,41,55,.03) 0px,
          rgba(31,41,55,.03) 1px,
          transparent 1px,
          transparent 7px
        );
      mix-blend-mode: multiply;
    }

    /* subtle stamp circle */
    body::after{
      content:"";
      position: fixed;
      width: 560px; height: 560px;
      left: -220px; top: -240px;
      border-radius: 999px;
      border: 2px solid rgba(185,28,28,.10);
      box-shadow: inset 0 0 0 18px rgba(185,28,28,.04);
      pointer-events:none;
      transform: rotate(-12deg);
    }

    .safeTop{ height: env(safe-area-inset-top); }
    .safeBottom{ height: env(safe-area-inset-bottom); }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(251,250,247,.90);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(31,41,55,.10);
    }
    .bar{
      padding: 12px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .title{ min-width:0; }
    h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.02em;
    }
    .sub{
      margin-top:2px;
      font-size:14px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .badgeRow{ display:flex; gap:8px; align-items:center; }
    .badge{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(185,28,28,.06);
      border: 1px solid rgba(185,28,28,.18);
      color: var(--vermilion);
      font-weight: 900;
      user-select:none;
    }
    .badge.mini{
      background: rgba(180,83,9,.06);
      border-color: rgba(180,83,9,.18);
      color: var(--gold);
    }

    main{
      max-width: 820px;
      margin: 0 auto;
      padding: 14px;
      padding-bottom: 96px; /* bottom nav space */
      min-height: calc(100dvh - 64px - 96px); /* header + bottomNav分ざっくり */
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(31,41,55,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* omikuji header card */
    .omikujiHead{
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .seal{
      width: 56px; height: 56px;
      border-radius: 16px;
      border: 2px solid rgba(185,28,28,.20);
      background: rgba(185,28,28,.06);
      position: relative;
      flex: 0 0 auto;
    }
    .seal::before{
      content:"神";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      letter-spacing:.08em;
      color: rgba(185,28,28,.75);
      font-size: 22px;
    }
    .omikujiText{ flex: 1; min-width:0; }
    .omikujiText .name{
      font-weight: 900;
      color: rgba(31,41,55,.85);
      font-size: 14px;
      letter-spacing:.06em;
    }
    .omikujiText .line{
      margin-top: 6px;
      font-size: 18px;
      line-height: 1.55;
    }
    .omikujiText .hint{
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
    }

    /* tabs */
    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px;
    }
    .tabBtn{
      flex: 1;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.55);
      color: rgba(31,41,55,.85);
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing:.02em;
      cursor:pointer;
      font-size: 16px;
    }
    .tabBtn.active{
      border-color: rgba(185,28,28,.30);
      background: rgba(185,28,28,.08);
      color: var(--vermilion);
    }

    .panel{
      padding: 14px;
      flex: 1 1 auto;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .result{
      white-space: pre-wrap;
      font-size: 22px;
      line-height: 1.7;
      letter-spacing: .01em;

      background: rgba(255,255,255,.62);
      border: 1px dashed rgba(185,28,28,.26);
      border-radius: 16px;
      padding: 16px 16px;

      /* 画面の縦を使う（お題が短くてもスカスカ回避） */
      flex: 1 1 auto;
      min-height: 34vh;
      display:flex;
      align-items: center;
    }

    /* reveal animation (oracle drop) */
    .reveal{ opacity: 0; transform: translateY(10px); filter: blur(8px); }
    .reveal.show{
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
      transition: all 420ms cubic-bezier(.2,.8,.2,1);
    }

    .chips{
      display:flex; flex-wrap:wrap; gap: 10px;
    }
    .chip{
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.55);
      color: rgba(31,41,55,.72);
    }
    .chip.red{
      border-color: rgba(185,28,28,.22);
      background: rgba(185,28,28,.06);
      color: rgba(185,28,28,.90);
      font-weight: 900;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      appearance:none;
      border:0;
      border-radius: 16px;
      padding: 16px 16px;
      font-weight: 900;
      cursor:pointer;
      letter-spacing:.02em;
      font-size: 18px;
      min-height: 56px;
    }
    .primary{
      background: linear-gradient(180deg, #ef4444, #b91c1c);
      color: #fff7f7;
      box-shadow: 0 14px 26px rgba(185,28,28,.18);
      flex: 1;
      min-width: 160px;
    }
    .ghost{
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(31,41,55,.12);
      color: rgba(31,41,55,.86);
      flex: 1;
      min-width: 140px;
    }
    .danger{
      background: rgba(185,28,28,.08);
      border: 1px solid rgba(185,28,28,.22);
      color: rgba(185,28,28,.92);
    }

    .small{
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
    }

    /* history */
    .list{ margin:0; padding:0; list-style:none; }
    #historyList{
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-top: 1px solid rgba(31,41,55,.10);
      margin-top: 6px;
    }
    .item{ padding: 12px 10px; border-top: 1px solid rgba(31,41,55,.10); }
    .item:first-child{ border-top:0; }
    .meta{
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* bottom nav */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 20;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(251,250,247,.92);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(31,41,55,.10);
    }
    .navInner{
      max-width: 820px;
      margin: 0 auto;
      display:flex;
      gap:10px;
    }
    .navBtn{
      flex:1;
      padding: 14px 12px;
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.62);
      color: rgba(31,41,55,.86);
      font-weight: 900;
      font-size: 18px;
      min-height: 56px;
    }
    .navBtn.main{
      border-color: rgba(185,28,28,.26);
      background: rgba(185,28,28,.06);
      color: var(--vermilion);
    }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(31,41,55,.12);
      color: rgba(31,41,55,.86);
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease;
      z-index: 30;
      font-size: 14px;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ opacity: 1; }

    /* ===== 超デカ文字（5倍級）モード：見た目ごと拡大 ===== */
    body.bigText{ --zoom: 5; }
    body.bigText main{
      transform: scale(var(--zoom));
      transform-origin: top left;
      width: calc(100% / var(--zoom));
    }
  </style>
</head>

<body>
<div class="safeTop"></div>

<header>
  <div class="bar">
    <div class="title">
      <h1>真さんぽ神</h1>
      <div class="sub">おみくじ風に「どこで×なにをする」を決める</div>
    </div>
    <div class="badgeRow">
      <button class="badge" id="btnBig" type="button" style="cursor:pointer;">デカ文字</button>
      <div class="badge mini">朱×金</div>
    </div>
  </div>
</header>

<main>
  <section class="card omikujiHead">
    <div class="seal" aria-hidden="true"></div>
    <div class="omikujiText">
      <div class="name">お告げ</div>
      <div class="line" id="oracleLine">よし。今日の散歩、引いてみるか。</div>
      <div class="hint" id="oracleHint">「お題を引く」で神託が降りる</div>
    </div>
  </section>

  <section class="card tabs" aria-label="タブ">
    <button class="tabBtn active" id="tabNow" type="button">おみくじ</button>
    <button class="tabBtn" id="tabHistory" type="button">履歴</button>
  </section>

  <section class="card panel" id="panelNow">
    <div class="result reveal" id="result">まだお題がありません。「お題を引く」を押してください。</div>
    <div class="chips" id="chips"></div>

    <div class="btnRow">
      <button class="primary" id="btnRoll" type="button">お題を引く</button>
      <button class="ghost" id="btnReroll" type="button">引き直す</button>
      <button class="danger" id="btnClear" type="button">履歴全削除</button>
    </div>

    <div class="small">
      地図は使いません。必要ならGoogleマップ等で自分で検索してOK。<br>
      電車系30%／検索あり50%寄せ／銭湯はたまに（連続しにくい）
    </div>
  </section>

  <section class="card panel" id="panelHistory" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div style="font-weight:900;">履歴（直近20件）</div>
      <div class="sub" id="historyHint">保存: 0件</div>
    </div>
    <ul class="list" id="historyList"></ul>
  </section>
</main>

<div class="bottomNav">
  <div class="navInner">
    <button class="navBtn main" id="navRoll" type="button">神託</button>
    <button class="navBtn" id="navToHistory" type="button">履歴</button>
  </div>
</div>

<div class="toast" id="toast">OK</div>

<script>
/** PWA登録（manifest/swがあるなら動く。無くてもアプリ本体は動く） */
(function registerSW(){
  if (!("serviceWorker" in navigator)) return;
  window.addEventListener("load", async () => {
    try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
  });
})();

/** ========= データ（MVP） ========= */
const WHERE = [
  {id:"w_train_1_walk_10_straight", text:"電車で1駅移動して降りて、まっすぐ10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_w_10", text:"電車で2駅移動して降りて、西に10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_e_10", text:"電車で2駅移動して降りて、東に10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_n_12", text:"電車で2駅移動して降りて、北に12分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_2_walk_s_12", text:"電車で2駅移動して降りて、南に12分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_3_walk_8", text:"電車で3駅移動して降りて、8分だけ歩いて", isTrain:true, difficulty:3},

  {id:"w_walk_w_10", text:"いまいる場所から西に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_e_10", text:"いまいる場所から東に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_n_10", text:"いまいる場所から北に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_s_10", text:"いまいる場所から南に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_5", text:"いまいる場所から5分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_8", text:"いまいる場所から8分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_12", text:"いまいる場所から12分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_15", text:"いまいる場所から15分だけ歩いて", isTrain:false, difficulty:2},

  {id:"w_main_road_12_no_turn", text:"大通りを選んで12分、曲がらず歩いて", isTrain:false, difficulty:2},
  {id:"w_backstreet_12", text:"裏道を選んで12分、なるべく信号を避けて歩いて", isTrain:false, difficulty:2},
  {id:"w_no_right_10", text:"右折禁止で10分歩いて（左か直進だけ）", isTrain:false, difficulty:3},
  {id:"w_no_left_10", text:"左折禁止で10分歩いて（右か直進だけ）", isTrain:false, difficulty:3},

  {id:"w_find_park_then_start", text:"近くの公園を1つ探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_find_shrine_then_start", text:"近くの神社/寺を1つ探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_find_shotengai_then_start", text:"近くの商店街を探して、入口っぽい所から始めて", isTrain:false, difficulty:3},
  {id:"w_find_cafe_then_start", text:"近くの喫茶店/カフェを探して、店の前から始めて", isTrain:false, difficulty:2},
  {id:"w_find_bookstore_then_start", text:"近くの本屋を探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_find_sentou_outside_then_start", text:"近くの銭湯を探して、外観を見たところから始めて", isTrain:false, difficulty:4}
];

const WHAT = [
  {id:"a_photo_red_3", text:"「赤」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_blue_3", text:"「青」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_shadow_3", text:"「影」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_reflection_2", text:"反射（ガラス/水たまり）を狙って写真を2枚撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_text_5", text:"文字が入った風景を写真で5枚集める", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_drink_unusual", text:"自販機で「普段絶対買わない飲み物」を1本買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_snack_unusual", text:"コンビニで「普段買わないお菓子」を1つ買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_100yen_weird_item", text:"100均で「役に立つか怪しい」小物を1つ探す（買っても買わなくてもOK）", needSearch:false, difficulty:3, timeRisk:"low"},
  {id:"a_no_earphones_10", text:"10分間、イヤホン無しで歩く", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_find_quiet_1min", text:"いちばん静かな場所を探して1分止まる", needSearch:false, difficulty:2, timeRisk:"low"},

  {id:"b_food_nearest_meal", text:"いちばん近い飲食店で食事する（ジャンル自由）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_nearest_cafe", text:"いちばん近いカフェ/喫茶店で1杯飲む", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_bakery_1", text:"近くのパン屋を探してパンを1個買う", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_wagashi_1", text:"近くの和菓子屋を探して和菓子を1個買う", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_teishoku", text:"近くの定食屋で日替わりを頼む", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_nonchain", text:"チェーンじゃない店を探して入る", needSearch:true, difficulty:4, timeRisk:"mid"},
  {id:"b_photo_park_season", text:"近くの公園へ行って季節っぽい写真を撮る", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_photo_shrine_gate", text:"近くの神社/寺へ行って入口（鳥居/山門）を撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_recycle", text:"近くの古本屋/リサイクルショップに入る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_sentou_optional", text:"近くの銭湯を探して、入るかどうかは気分で決める（外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"high"}
];

/** ========= 設定 ========= */
const TRAIN_RATIO = 0.30;
const NEED_SEARCH_TARGET = 0.50;
const HISTORY_MAX = 20;
const KEY = "shin_sanpo_gami_history_washi_big_v1";
const KEY_BIG = "shin_sanpo_gami_bigtext_on";

/** 永続化 */
function loadHistory(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveHistory(list){
  localStorage.setItem(KEY, JSON.stringify(list.slice(0, HISTORY_MAX)));
}
function loadBig(){
  try{ return localStorage.getItem(KEY_BIG) === "1"; }catch{ return false; }
}
function saveBig(on){
  try{ localStorage.setItem(KEY_BIG, on ? "1":"0"); }catch{}
}

/** 抽選補助 */
function recentNeedSearchRatio(hist){
  const recent = hist.slice(0, 10);
  if(recent.length === 0) return 0.5;
  const need = recent.filter(x => x.what_need_search === true).length;
  return need / recent.length;
}
function recentHasHigh(hist){
  const recent = hist.slice(0, 5);
  return recent.some(x => x.what_time_risk === "high");
}
function diffCounts(hist){
  const recent = hist.slice(0, 10);
  const m = new Map();
  for(const x of recent){
    const d = Number(x.what_difficulty || 1);
    m.set(d, (m.get(d) || 0) + 1);
  }
  return m;
}
const rng = (n) => Math.floor(Math.random() * n);
const pickOne = (arr) => arr[rng(arr.length)];

/** 抽選 */
function pickWhere(hist){
  const trainPool = WHERE.filter(w => w.isTrain);
  const nonTrainPool = WHERE.filter(w => !w.isTrain);
  const useTrain = trainPool.length > 0 && Math.random() < TRAIN_RATIO;
  const pool = useTrain ? trainPool : nonTrainPool;
  return pickOne(pool);
}
function pickWhat(hist){
  const r = recentNeedSearchRatio(hist);
  const wantNeedSearch = r < NEED_SEARCH_TARGET;

  let pool = WHAT.filter(w => w.needSearch === wantNeedSearch);
  if(pool.length === 0) pool = WHAT.slice();

  if(recentHasHigh(hist)){
    const filtered = pool.filter(w => w.timeRisk !== "high");
    if(filtered.length > 0) pool = filtered;
  }

  const counts = diffCounts(hist);
  pool = pool.slice().sort((a,b) => (counts.get(a.difficulty)||0) - (counts.get(b.difficulty)||0));
  return pool[0];
}

/** UI */
const $ = (id) => document.getElementById(id);
const $result = $("result");
const $chips = $("chips");
const $historyList = $("historyList");
const $historyHint = $("historyHint");
const $oracleLine = $("oracleLine");
const $oracleHint = $("oracleHint");
const $toast = $("toast");

const $tabNow = $("tabNow");
const $tabHistory = $("tabHistory");
const $panelNow = $("panelNow");
const $panelHistory = $("panelHistory");
const $btnBig = $("btnBig");

let history = loadHistory();

function toast(msg){
  $toast.textContent = msg;
  $toast.classList.add("show");
  setTimeout(() => $toast.classList.remove("show"), 1200);
}
function setTab(which){
  const now = (which === "now");
  $tabNow.classList.toggle("active", now);
  $tabHistory.classList.toggle("active", !now);
  $panelNow.style.display = now ? "flex" : "none";
  $panelHistory.style.display = now ? "none" : "flex";
}
function renderChips(where, what){
  const chips = [
    {t:`検索: ${what.needSearch ? "あり" : "なし"}`, red:true},
    {t:`難易度: ${what.difficulty}`, red:false},
    {t:`電車: ${where.isTrain ? "あり" : "なし"}`, red:false},
    {t:`時間リスク: ${what.timeRisk}`, red:false}
  ];
  $chips.innerHTML = chips.map(c => `<span class="chip ${c.red ? "red":""}">${c.t}</span>`).join("");
}
function renderHistory(){
  const list = history.slice(0, HISTORY_MAX);
  $historyHint.textContent = `保存: ${list.length}件`;
  $historyList.innerHTML = "";
  for(const e of list){
    const li = document.createElement("li");
    li.className = "item";
    const title = document.createElement("div");
    title.textContent = `${e.where_text}\n→ ${e.what_text}`;
    title.style.whiteSpace = "pre-wrap";

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <span>検索:${e.what_need_search ? "あり" : "なし"}</span>
      <span>難易度:${e.what_difficulty}</span>
      <span>電車:${e.where_is_train ? "あり" : "なし"}</span>
      <span>リスク:${e.what_time_risk}</span>
    `;
    li.appendChild(title);
    li.appendChild(meta);
    $historyList.appendChild(li);
  }
}
function oracleSay(line, hint){
  $oracleLine.textContent = line;
  $oracleHint.textContent = hint || "";
}
function revealResult(){
  $result.classList.remove("show");
  $result.classList.add("reveal");
  requestAnimationFrame(() => {
    requestAnimationFrame(() => $result.classList.add("show"));
  });
}
function roll(kind){
  const where = pickWhere(history);
  const what = pickWhat(history);

  $result.textContent = `${where.text}\n→ ${what.text}`;
  renderChips(where, what);
  revealResult();

  const item = {
    where_id: where.id,
    where_text: where.text,
    where_is_train: where.isTrain,
    what_id: what.id,
    what_text: what.text,
    what_need_search: what.needSearch,
    what_difficulty: what.difficulty,
    what_time_risk: what.timeRisk,
    created_at: new Date().toISOString()
  };

  history.unshift(item);
  history = history.slice(0, HISTORY_MAX);
  saveHistory(history);
  renderHistory();

  const lines = [
    "よし。神託が降りた。",
    "迷うな。これが縁だ。",
    "今日はこれでいけ。",
    "運命の散歩、始めよ。",
    "ふむ…これで良い。"
  ];
  const hints = [
    what.needSearch ? "必要なら検索してよい" : "今日は検索なしでよい",
    where.isTrain ? "電車を使ってよい" : "徒歩でよい",
    what.timeRisk === "high" ? "無理はするな（外観だけでも可）" : "気軽に行け"
  ];
  oracleSay(pickOne(lines), pickOne(hints));
  toast(kind === "reroll" ? "引き直し" : "神託！");
  setTab("now");
}

/** デカ文字切替 */
function setBig(on){
  document.body.classList.toggle("bigText", on);
  $btnBig.textContent = on ? "デカ文字ON" : "デカ文字";
  saveBig(on);
  toast(on ? "デカ文字ON" : "デカ文字OFF");
}

/** events */
$("btnRoll").addEventListener("click", () => roll("roll"));
$("btnReroll").addEventListener("click", () => roll("reroll"));
$("navRoll").addEventListener("click", () => roll("roll"));
$("navToHistory").addEventListener("click", () => setTab("history"));
$tabNow.addEventListener("click", () => setTab("now"));
$tabHistory.addEventListener("click", () => setTab("history"));

$("btnClear").addEventListener("click", () => {
  if(!confirm("履歴を全削除します。よろしいですか？")) return;
  history = [];
  saveHistory(history);
  renderHistory();
  $result.textContent = "履歴を削除しました。「お題を引く」を押してください。";
  $chips.innerHTML = "";
  oracleSay("清めた。", "また引け");
  revealResult();
  toast("削除");
});

$btnBig.addEventListener("click", () => setBig(!document.body.classList.contains("bigText")));

/** init */
renderHistory();
setTab("now");
setBig(loadBig()); /* 前回設定を復元 */
</script>

<div class="safeBottom"></div>
</body>
</html>
