<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>真さんぽ神</title>

  <meta name="theme-color" content="#b91c1c" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap">

  <style>
    :root{
      --paper:#fbfaf7;
      --paper2:#f6f2ea;
      --ink:#1f2937;
      --muted:#6b7280;

      --vermilion:#b91c1c;
      --gold:#b45309;

      --card: rgba(255,255,255,.74);
      --shadow: 0 18px 45px rgba(17,24,39,.12);
      --radius: 18px;

      --zoom: 1; /* デカ文字倍率 */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: "Zen Maru Gothic", system-ui, -apple-system, "Noto Sans JP", sans-serif;

      background:
        radial-gradient(900px 650px at 18% 6%, rgba(185,28,28,.08), transparent 55%),
        radial-gradient(850px 600px at 85% 18%, rgba(180,83,9,.08), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      position: relative;
    }

    /* 和紙っぽい繊維 */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .25;
      background:
        repeating-linear-gradient( 12deg,
          rgba(31,41,55,.04) 0px,
          rgba(31,41,55,.04) 1px,
          transparent 1px,
          transparent 6px
        ),
        repeating-linear-gradient(-12deg,
          rgba(31,41,55,.03) 0px,
          rgba(31,41,55,.03) 1px,
          transparent 1px,
          transparent 7px
        );
      mix-blend-mode: multiply;
    }

    /* 朱印っぽい円 */
    body::after{
      content:"";
      position: fixed;
      width: 560px; height: 560px;
      left: -220px; top: -240px;
      border-radius: 999px;
      border: 2px solid rgba(185,28,28,.10);
      box-shadow: inset 0 0 0 18px rgba(185,28,28,.04);
      pointer-events:none;
      transform: rotate(-12deg);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(251,250,247,.90);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(31,41,55,.10);
    }
    .bar{
      padding: 12px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .title{ min-width:0; }
    h1{ margin:0; font-size: 20px; letter-spacing:.02em; }
    .sub{ margin-top:2px; font-size:14px; color: var(--muted); }

    .badgeRow{ display:flex; gap:8px; align-items:center; }
    .badge{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(185,28,28,.06);
      border: 1px solid rgba(185,28,28,.18);
      color: var(--vermilion);
      font-weight: 900;
      user-select:none;
    }
    .badge.mini{
      background: rgba(180,83,9,.06);
      border-color: rgba(180,83,9,.18);
      color: var(--gold);
    }

    main{
      max-width: 820px;
      margin: 0 auto;
      padding: 14px;
      padding-bottom: 96px;
      min-height: calc(100dvh - 64px - 96px);
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(31,41,55,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .omikujiHead{
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .seal{
      width: 56px; height: 56px;
      border-radius: 16px;
      border: 2px solid rgba(185,28,28,.20);
      background: rgba(185,28,28,.06);
      position: relative;
      flex: 0 0 auto;
    }
    .seal::before{
      content:"神";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      letter-spacing:.08em;
      color: rgba(185,28,28,.75);
      font-size: 22px;
    }
    .omikujiText{ flex: 1; min-width:0; }
    .omikujiText .name{ font-weight: 900; font-size: 14px; letter-spacing:.06em; }
    .omikujiText .line{ margin-top: 6px; font-size: 18px; line-height: 1.55; }
    .omikujiText .hint{ margin-top: 6px; font-size: 14px; color: var(--muted); }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px;
    }
    .tabBtn{
      flex: 1;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.55);
      color: rgba(31,41,55,.85);
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      font-size: 16px;
    }
    .tabBtn.active{
      border-color: rgba(185,28,28,.30);
      background: rgba(185,28,28,.08);
      color: var(--vermilion);
    }

    .panel{
      padding: 14px;
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    /* お題（上寄せ＋読み物） */
    .result{
      white-space: pre-wrap;
      font-size: 22px;
      line-height: 1.7;
      letter-spacing: .01em;

      background: rgba(255,255,255,.62);
      border: 1px dashed rgba(185,28,28,.26);
      border-radius: 16px;
      padding: 16px 16px;

      flex: 1 1 auto;
      min-height: 0;

      display:flex;
      align-items: flex-start;
    }

    .reveal{ opacity: 0; transform: translateY(10px); filter: blur(8px); }
    .reveal.show{
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
      transition: all 420ms cubic-bezier(.2,.8,.2,1);
    }

    .chips{
      display:flex; flex-wrap:wrap; gap: 10px;
    }
    .chip{
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.55);
      color: rgba(31,41,55,.72);
    }
    .chip.red{
      border-color: rgba(185,28,28,.22);
      background: rgba(185,28,28,.06);
      color: rgba(185,28,28,.90);
      font-weight: 900;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      appearance:none;
      border:0;
      border-radius: 16px;
      padding: 16px 16px;
      font-weight: 900;
      cursor:pointer;
      letter-spacing:.02em;
      font-size: 18px;
      min-height: 56px;
    }
    .primary{
      background: linear-gradient(180deg, #ef4444, #b91c1c);
      color: #fff7f7;
      box-shadow: 0 14px 26px rgba(185,28,28,.18);
      flex: 1;
      min-width: 160px;
    }
    .ghost{
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(31,41,55,.12);
      color: rgba(31,41,55,.86);
      flex: 1;
      min-width: 140px;
    }
    .danger{
      background: rgba(185,28,28,.08);
      border: 1px solid rgba(185,28,28,.22);
      color: rgba(185,28,28,.92);
    }

    .small{
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
    }

    /* history */
    .list{ margin:0; padding:0; list-style:none; }
    #historyList{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-top: 1px solid rgba(31,41,55,.10);
      margin-top: 6px;
    }
    .item{ padding: 12px 10px; border-top: 1px solid rgba(31,41,55,.10); }
    .item:first-child{ border-top:0; }
    .meta{
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* bottom nav */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 20;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(251,250,247,.92);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(31,41,55,.10);
    }
    .navInner{
      max-width: 820px;
      margin: 0 auto;
      display:flex;
      gap:10px;
    }
    .navBtn{
      flex:1;
      padding: 14px 12px;
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.62);
      color: rgba(31,41,55,.86);
      font-weight: 900;
      font-size: 18px;
      min-height: 56px;
    }
    .navBtn.main{
      border-color: rgba(185,28,28,.26);
      background: rgba(185,28,28,.06);
      color: var(--vermilion);
    }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(31,41,55,.12);
      color: rgba(31,41,55,.86);
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease;
      z-index: 30;
      font-size: 14px;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ opacity: 1; }

    /* ===== 超デカ文字（2倍級）モード（必要ならON） ===== */
    body.bigText{ --zoom: 2.5; }
    body.bigText main{
      transform: scale(var(--zoom));
      transform-origin: top left;
      width: calc(100% / var(--zoom));
      min-height: auto;
    }
  </style>
</head>

<body>
<header>
  <div class="bar">
    <div class="title">
      <h1>真さんぽ神</h1>
      <div class="sub">おみくじ風に「どこで×なにをする」を決める</div>
    </div>
    <div class="badgeRow">
      <button class="badge" id="btnBig" type="button" style="cursor:pointer;">デカ文字</button>
      <div class="badge mini">朱×金</div>
    </div>
  </div>
</header>

<main>
  <section class="card omikujiHead">
    <div class="seal" aria-hidden="true"></div>
    <div class="omikujiText">
      <div class="name">お告げ</div>
      <div class="line" id="oracleLine">よし。今日の散歩、引いてみるか。</div>
      <div class="hint" id="oracleHint">「お題を引く」で神託が降りる</div>
    </div>
  </section>

  <section class="card tabs" aria-label="タブ">
    <button class="tabBtn active" id="tabNow" type="button">おみくじ</button>
    <button class="tabBtn" id="tabHistory" type="button">履歴</button>
  </section>

  <section class="card panel" id="panelNow">
    <div class="result reveal" id="result">まだお題がありません。「お題を引く」を押してください。</div>
    <div class="chips" id="chips"></div>

    <div class="btnRow">
      <button class="primary" id="btnRoll" type="button">お題を引く</button>
      <button class="ghost" id="btnReroll" type="button">引き直す</button>
      <button class="danger" id="btnClear" type="button">履歴全削除</button>
    </div>

    <div class="small">
      地図は使いません。必要ならGoogleマップ等で自分で検索してOK。<br>
      電車系30%／検索あり50%寄せ／銭湯はたまに（連続しにくい）
    </div>
  </section>

  <section class="card panel" id="panelHistory" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div style="font-weight:900;">履歴（直近20件）</div>
      <div class="sub" id="historyHint">保存: 0件</div>
    </div>
    <ul class="list" id="historyList"></ul>
  </section>
</main>

<div class="bottomNav">
  <div class="navInner">
    <button class="navBtn main" id="navRoll" type="button">神託</button>
    <button class="navBtn" id="navToHistory" type="button">履歴</button>
  </div>
</div>

<div class="toast" id="toast">OK</div>

<script>
/** PWA登録（manifest/swがあるなら動く。無くても本体は動く） */
(function registerSW(){
  if (!("serviceWorker" in navigator)) return;
  window.addEventListener("load", async () => {
    try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
  });
})();

/** ========= 設定 ========= */
const TRAIN_RATIO = 0.30;
const NEED_SEARCH_TARGET = 0.50;
const HISTORY_MAX = 20;
const KEY = "shin_sanpo_gami_history_bigpack_v1";
const KEY_BIG = "shin_sanpo_gami_bigtext_on";

/** ========= WHERE（どこで）大量版 =========
 * 方針：徒歩5〜15分中心＋電車雰囲気（30%）＋検索目的地＋制約プレイ少量
 */
const WHERE = [
  // --- train
  {id:"w_train_1_walk_10_straight", text:"電車で1駅移動して降りて、まっすぐ10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_w_10", text:"電車で2駅移動して降りて、西に10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_e_10", text:"電車で2駅移動して降りて、東に10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_n_12", text:"電車で2駅移動して降りて、北に12分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_2_walk_s_12", text:"電車で2駅移動して降りて、南に12分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_3_walk_8", text:"電車で3駅移動して降りて、8分だけ歩いて", isTrain:true, difficulty:3},
  {id:"w_train_1_walk_12_straight", text:"電車で1駅移動して降りて、まっすぐ12分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_8", text:"電車で2駅移動して降りて、8分だけ歩いて", isTrain:true, difficulty:2},
  {id:"w_train_3_walk_quiet_10", text:"電車で3駅移動して降りて、静かな道を10分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_2_walk_busy_12", text:"電車で2駅移動して降りて、にぎやかな方へ12分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_2_walk_after_cross_3", text:"電車で2駅移動して降りて、交差点を3回越えたら始めて", isTrain:true, difficulty:3},
  {id:"w_train_2_first_right_8", text:"電車で2駅移動して降りて、最初の角を右に曲がって8分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_2_first_left_8", text:"電車で2駅移動して降りて、最初の角を左に曲がって8分歩いて", isTrain:true, difficulty:3},
  {id:"w_train_2_walk_quiet_10", text:"電車で2駅移動して降りて、静かな道を10分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_1_walk_busy_12", text:"電車で1駅移動して降りて、にぎやかな方へ12分歩いて", isTrain:true, difficulty:2},
  {id:"w_train_3_walk_5", text:"電車で3駅移動して降りて、5分だけ歩いて", isTrain:true, difficulty:3},

  // --- walk basic
  {id:"w_walk_w_10", text:"いまいる場所から西に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_e_10", text:"いまいる場所から東に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_n_10", text:"いまいる場所から北に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_s_10", text:"いまいる場所から南に10分歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_5", text:"いまいる場所から5分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_6", text:"いまいる場所から6分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_8", text:"いまいる場所から8分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_9", text:"いまいる場所から9分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_11", text:"いまいる場所から11分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_12", text:"いまいる場所から12分だけ歩いて", isTrain:false, difficulty:1},
  {id:"w_walk_14", text:"いまいる場所から14分だけ歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_15", text:"いまいる場所から15分だけ歩いて", isTrain:false, difficulty:2},

  // --- feel / route choices
  {id:"w_main_road_12_no_turn", text:"大通りを選んで12分、曲がらず歩いて", isTrain:false, difficulty:2},
  {id:"w_backstreet_12", text:"裏道を選んで12分、なるべく信号を避けて歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_follow_sun_10", text:"日当たりが良い方を選んで10分歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_follow_shade_10", text:"日陰が多い方を選んで10分歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_toward_green_12", text:"緑が多そうな方へ12分歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_toward_shops_10", text:"店が多そうな方へ10分歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_toward_quiet_10", text:"人が少なそうな方へ10分歩いて", isTrain:false, difficulty:2},
  {id:"w_walk_straight_until_deadend_15", text:"なるべく曲がらず、行き止まりか大きい道に当たるまで歩いて（最大15分）", isTrain:false, difficulty:3},
  {id:"w_walk_find_bridge_then_start", text:"橋か踏切を見つけるまで歩いて、見つけた場所から始めて", isTrain:false, difficulty:3},
  {id:"w_walk_find_bench_then_start", text:"ベンチを1つ見つけるまで歩いて、見つけた場所から始めて", isTrain:false, difficulty:2},

  // --- rules
  {id:"w_no_right_10", text:"右折禁止で10分歩いて（左か直進だけ）", isTrain:false, difficulty:3},
  {id:"w_no_left_10", text:"左折禁止で10分歩いて（右か直進だけ）", isTrain:false, difficulty:3},
  {id:"w_rule_only_right_12", text:"12分間、右に曲がれる時は右を優先して歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_only_left_12", text:"12分間、左に曲がれる時は左を優先して歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_coinflip_10", text:"角が出るたびにコイントス（表=右/裏=左）で10分歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_find_vending3_then_start", text:"自販機を3台見つけた地点から始めて", isTrain:false, difficulty:3},
  {id:"w_rule_find_sign_then_start", text:"気になる看板を1つ見つけたら、そこから始めて", isTrain:false, difficulty:2},
  {id:"w_rule_color_hunt_12", text:"最初に見えた“好きな色”を決めて、その色の看板がある方へ12分歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_turn_every_3min", text:"3分歩くたびに、次の角で必ず曲がって10〜12分歩いて", isTrain:false, difficulty:4},
  {id:"w_rule_one_alley_required", text:"路地に1回だけ入ってから、元の道に戻って8分歩いて", isTrain:false, difficulty:3},

  // --- search start points
  {id:"w_find_park_then_start", text:"近くの公園を1つ探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_find_shrine_then_start", text:"近くの神社/寺を1つ探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_find_shotengai_then_start", text:"近くの商店街を探して、入口っぽい所から始めて", isTrain:false, difficulty:3},
  {id:"w_find_cafe_then_start", text:"近くの喫茶店/カフェを探して、店の前から始めて", isTrain:false, difficulty:2},
  {id:"w_find_bookstore_then_start", text:"近くの本屋を探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_find_sentou_outside_then_start", text:"近くの銭湯を探して、外観を見たところから始めて", isTrain:false, difficulty:4},
  {id:"w_search_find_coffee_roaster_start", text:"近くのコーヒーが飲めそうな店を探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_search_find_sweets_start", text:"近くの甘いものが買えそうな店を探して、店の前から始めて", isTrain:false, difficulty:2},
  {id:"w_search_find_shopping_street_start", text:"近くの商店街を探して、入口っぽい所から始めて", isTrain:false, difficulty:3},
  {id:"w_search_find_park_start2", text:"近くの公園を探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_search_find_bridge_start", text:"近くの橋を探して、橋のたもとから始めて", isTrain:false, difficulty:3},
  {id:"w_search_find_kissaten_start", text:"近くの喫茶店（チェーン以外優先）を探して、店の前から始めて", isTrain:false, difficulty:3},
  {id:"w_search_find_wagashi_start", text:"近くの和菓子屋を探して、店の前から始めて", isTrain:false, difficulty:3},
  {id:"w_search_find_bakery_start2", text:"近くのパン屋を探して、店の前から始めて", isTrain:false, difficulty:2},
  {id:"w_search_find_shrine2_start", text:"近くの神社/寺を探して、入口から始めて", isTrain:false, difficulty:2},
  {id:"w_search_find_bookstore2_start", text:"近くの本屋を探して、入口から始めて", isTrain:false, difficulty:2},
];

/** ========= WHAT（なにをする）大量版 =========
 * 方針：検索なし/ありがほぼ均等。飲食/買い物/写真/観察をバランスよく。
 */
const WHAT = [
  // --- no search: photo
  {id:"a_photo_red_3", text:"「赤」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_blue_3", text:"「青」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_shadow_3", text:"「影」をテーマに写真を3枚撮る", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_photo_reflection_2", text:"反射（ガラス/水たまり）を狙って写真を2枚撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_text_5", text:"文字が入った風景を写真で5枚集める", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_round_5", text:"丸いものを5個見つけて写真を撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_square_5", text:"四角いものを5個見つけて写真を撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_letters_10", text:"文字が写る写真を10枚撮る（看板/注意書きOK）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_reflection_5", text:"反射（ガラス/水たまり/金属）を5つ集めて写真を撮る", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_same_color_7", text:"同じ色を7個集める（写真でもOK）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_best_1_edit", text:"今日のベスト写真を1枚だけ選んで、軽く編集する", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_red_7", text:"「赤」を7個見つけて写真を撮る", needSearch:false, difficulty:2, timeRisk:"mid"},
  {id:"a_photo_blue_7", text:"「青」を7個見つけて写真を撮る", needSearch:false, difficulty:2, timeRisk:"mid"},
  {id:"a_photo_texture_5", text:"質感（つるつる/ざらざら/木/金属など）を5つ集めて写真を撮る", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_photo_door_3", text:"ドアを3つ撮る（家じゃなく店のドア優先）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_window_3", text:"窓を3つ撮る（反射が写ったら当たり）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_shadow_long", text:"影が長い場所を探して写真を1枚撮る", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_photo_stairs_2", text:"階段を2つ撮る（上から/下からのどちらか）", needSearch:false, difficulty:2, timeRisk:"low"},

  // --- no search: shopping
  {id:"a_buy_drink_unusual", text:"自販機で「普段絶対買わない飲み物」を1本買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_buy_snack_unusual", text:"コンビニで「普段買わないお菓子」を1つ買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_shop_drink_new", text:"コンビニで“見たことない飲み物”を1本買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_shop_snack_random", text:"コンビニで“普段の自分なら選ばないお菓子”を1つ買う", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_shop_1000_yen_gift", text:"1000円以内で“自分へのおみやげ”を1つ選ぶ（買う/買わないは自由）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_shop_100yen_stationery", text:"100均で“変な文房具”を1つ探す（買う/買わない自由）", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_shop_drink_color_rule", text:"自販機/コンビニで“今日はこの色”を決めて、その色の飲み物を選ぶ", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_shop_snack_spicy_or_sour", text:"辛い/酸っぱい/苦いのどれかを選んで、少量だけ試す", needSearch:false, difficulty:3, timeRisk:"mid"},
  {id:"a_shop_omiyage_500", text:"500円以内で“今日の記念”を1つ選ぶ（買う/買わない自由）", needSearch:false, difficulty:2, timeRisk:"low"},
  {id:"a_shop_stationery_view", text:"文房具コーナーで“変な付箋/ペン”を探す（買わなくてOK）", needSearch:false, difficulty:2, timeRisk:"low"},

  // --- no search: observe / act
  {id:"a_observe_cute_sign", text:"今日いちばん“かわいい看板”を決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_strong_shopname", text:"今日いちばん“強そうな店名”を1つ見つける", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_best_smell", text:"今日いちばん“いい匂いがした場所”を1つ決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_observe_best_bgm", text:"今日いちばん“雰囲気が良い店”を外観だけで1つ決める", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_walk_no_music_15", text:"15分だけイヤホン無しで歩く", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_walk_silent_5", text:"5分だけ無言で歩いて、音を聞く", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_rest_2min", text:"どこか安全な場所で2分休憩して深呼吸する", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_rest_breath_1", text:"1分だけ立ち止まって深呼吸する", needSearch:false, difficulty:1, timeRisk:"low"},
  {id:"a_route_detour_one", text:"いつもなら行かない道を1本だけ通ってみる（安全な範囲）", needSearch:false, difficulty:2, timeRisk:"mid"},

  // --- search: food (cafe/sweets & meals)
  {id:"b_food_nearest_meal", text:"いちばん近い飲食店で食事する（ジャンル自由）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_nearest_cafe", text:"いちばん近いカフェ/喫茶店で1杯飲む", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_bakery_1", text:"近くのパン屋を探してパンを1個買う", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_wagashi_1", text:"近くの和菓子屋を探して和菓子を1個買う", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_teishoku", text:"近くの定食屋で日替わりを頼む", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_machichuka_one", text:"近くの町中華で一品だけ食べる（軽めでOK）", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_kissaten_coffee", text:"近くの喫茶店でコーヒー/紅茶を1杯飲む", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_food_sweets", text:"近くで甘いもの（ケーキ/和菓子/アイス）を1つ食べる", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_bakery_recommend", text:"近くのパン屋で“おすすめっぽいパン”を1つ買う", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_teishoku_basic", text:"近くのごはん屋で“定番っぽい定食”を食べる", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_noodle", text:"近くの麺（そば/うどん/ラーメン等）を食べる（量は軽めでもOK）", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_takeout", text:"近くでテイクアウトを1つ買う（食べるのは後でもOK）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_food_takeout_park", text:"テイクアウトを買って、公園か広い場所で食べる（無理なら持ち帰り）", needSearch:true, difficulty:3, timeRisk:"high"},
  {id:"b_food_nonchain_challenge", text:"チェーンじゃない店を1つ探して入る（無理なら外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"mid"},
  {id:"b_food_seasonal", text:"季節限定/期間限定っぽいものを1つ探して食べる（飲み物でもOK）", needSearch:true, difficulty:4, timeRisk:"mid"},

  // --- search: shopping
  {id:"b_shop_bookstore_unknown", text:"近くの本屋で「知らない分野」の本を1冊探す（購入は任意）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_recycle", text:"近くの古本屋/リサイクルショップに入る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_zakka", text:"近くの雑貨屋で小さなお土産を探す（購入は任意）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_flowers", text:"近くの花屋で季節の花を1輪探す（購入は任意）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_bookstore_cover", text:"近くの本屋で“表紙が刺さる本”を1冊探す（購入自由）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_bookstore_unknown_genre", text:"近くの本屋で“普段読まないジャンル”の棚を1つ見る（買わなくてOK）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_zakka_small", text:"近くの雑貨屋で“手のひらサイズの物”を探す（買わなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_shop_flower_view", text:"近くの花屋で“季節っぽい花”を眺める（買わなくてOK）", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_shop_reuse_walkthrough", text:"近くの古本屋/リサイクルショップに入って1周する（買わなくてOK）", needSearch:true, difficulty:3, timeRisk:"mid"},

  // --- search: photo spots
  {id:"b_photo_park_season", text:"近くの公園へ行って季節っぽい写真を撮る", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_photo_water_reflection", text:"近くの川/水辺へ行って反射の写真を撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_shrine_gate", text:"近くの神社/寺へ行って入口（鳥居/山門）を撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_underpass_shadow", text:"近くのガード下/高架下へ行って陰影の写真を撮る", needSearch:true, difficulty:4, timeRisk:"mid"},
  {id:"b_photo_park_green", text:"近くの公園へ行って“緑が多い写真”を1枚撮る", needSearch:true, difficulty:2, timeRisk:"mid"},
  {id:"b_photo_bridge_lines", text:"近くの橋へ行って“線”が気持ちいい写真を1枚撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_shrine_gate2", text:"近くの神社/寺へ行って入口を撮る（人が多ければ遠目でOK）", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_shotengai_signs", text:"近くの商店街で“看板”を10枚撮る", needSearch:true, difficulty:3, timeRisk:"mid"},
  {id:"b_photo_shotengai_letters", text:"近くの商店街に行って“文字の写真”を10枚撮る", needSearch:true, difficulty:3, timeRisk:"mid"},

  // --- rare: sentou (cooldown already handled)
  {id:"b_sentou_optional", text:"近くの銭湯を探して、入るかどうかは気分で決める（外観だけでもOK）", needSearch:true, difficulty:4, timeRisk:"high"},
];

/** ========= 永続化 ========= */
function loadHistory(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveHistory(list){
  localStorage.setItem(KEY, JSON.stringify(list.slice(0, HISTORY_MAX)));
}
function loadBig(){
  try{ return localStorage.getItem(KEY_BIG) === "1"; }catch{ return false; }
}
function saveBig(on){
  try{ localStorage.setItem(KEY_BIG, on ? "1":"0"); }catch{}
}

/** ========= 抽選補助 ========= */
function recentNeedSearchRatio(hist){
  const recent = hist.slice(0, 10);
  if(recent.length === 0) return 0.5;
  const need = recent.filter(x => x.what_need_search === true).length;
  return need / recent.length;
}
function recentHasHigh(hist){
  const recent = hist.slice(0, 5);
  return recent.some(x => x.what_time_risk === "high");
}
function diffCounts(hist){
  const recent = hist.slice(0, 10);
  const m = new Map();
  for(const x of recent){
    const d = Number(x.what_difficulty || 1);
    m.set(d, (m.get(d) || 0) + 1);
  }
  return m;
}
const rng = (n) => Math.floor(Math.random() * n);
const pickOne = (arr) => arr[rng(arr.length)];

/** ========= 抽選 ========= */
function pickWhere(hist){
  const trainPool = WHERE.filter(w => w.isTrain);
  const nonTrainPool = WHERE.filter(w => !w.isTrain);
  const useTrain = trainPool.length > 0 && Math.random() < TRAIN_RATIO;
  const pool = useTrain ? trainPool : nonTrainPool;
  return pickOne(pool);
}
function pickWhat(hist){
  const r = recentNeedSearchRatio(hist);
  const wantNeedSearch = r < NEED_SEARCH_TARGET;

  let pool = WHAT.filter(w => w.needSearch === wantNeedSearch);
  if(pool.length === 0) pool = WHAT.slice();

  if(recentHasHigh(hist)){
    const filtered = pool.filter(w => w.timeRisk !== "high");
    if(filtered.length > 0) pool = filtered;
  }

  const counts = diffCounts(hist);
  pool = pool.slice().sort((a,b) => (counts.get(a.difficulty)||0) - (counts.get(b.difficulty)||0));
  return pool[0];
}

/** ========= UI ========= */
const $ = (id) => document.getElementById(id);
const $result = $("result");
const $chips = $("chips");
const $historyList = $("historyList");
const $historyHint = $("historyHint");
const $oracleLine = $("oracleLine");
const $oracleHint = $("oracleHint");
const $toast = $("toast");

const $tabNow = $("tabNow");
const $tabHistory = $("tabHistory");
const $panelNow = $("panelNow");
const $panelHistory = $("panelHistory");

const $btnBig = $("btnBig");

let history = loadHistory();

function toast(msg){
  $toast.textContent = msg;
  $toast.classList.add("show");
  setTimeout(() => $toast.classList.remove("show"), 1200);
}
function setTab(which){
  const now = (which === "now");
  $tabNow.classList.toggle("active", now);
  $tabHistory.classList.toggle("active", !now);
  $panelNow.style.display = now ? "flex" : "none";
  $panelHistory.style.display = now ? "none" : "flex";
}
function renderChips(where, what){
  const chips = [
    {t:`検索: ${what.needSearch ? "あり" : "なし"}`, red:true},
    {t:`難易度: ${what.difficulty}`, red:false},
    {t:`電車: ${where.isTrain ? "あり" : "なし"}`, red:false},
    {t:`時間リスク: ${what.timeRisk}`, red:false}
  ];
  $chips.innerHTML = chips.map(c => `<span class="chip ${c.red ? "red":""}">${c.t}</span>`).join("");
}
function renderHistory(){
  const list = history.slice(0, HISTORY_MAX);
  $historyHint.textContent = `保存: ${list.length}件`;
  $historyList.innerHTML = "";
  for(const e of list){
    const li = document.createElement("li");
    li.className = "item";
    const title = document.createElement("div");
    title.textContent = `${e.where_text}\n→ ${e.what_text}`;
    title.style.whiteSpace = "pre-wrap";

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <span>検索:${e.what_need_search ? "あり" : "なし"}</span>
      <span>難易度:${e.what_difficulty}</span>
      <span>電車:${e.where_is_train ? "あり" : "なし"}</span>
      <span>リスク:${e.what_time_risk}</span>
    `;
    li.appendChild(title);
    li.appendChild(meta);
    $historyList.appendChild(li);
  }
}
function oracleSay(line, hint){
  $oracleLine.textContent = line;
  $oracleHint.textContent = hint || "";
}
function revealResult(){
  $result.classList.remove("show");
  $result.classList.add("reveal");
  requestAnimationFrame(() => {
    requestAnimationFrame(() => $result.classList.add("show"));
  });
}
function roll(kind){
  const where = pickWhere(history);
  const what = pickWhat(history);

  $result.textContent = `${where.text}\n→ ${what.text}`;
  renderChips(where, what);
  revealResult();

  const item = {
    where_id: where.id,
    where_text: where.text,
    where_is_train: where.isTrain,
    what_id: what.id,
    what_text: what.text,
    what_need_search: what.needSearch,
    what_difficulty: what.difficulty,
    what_time_risk: what.timeRisk,
    created_at: new Date().toISOString()
  };

  history.unshift(item);
  history = history.slice(0, HISTORY_MAX);
  saveHistory(history);
  renderHistory();

  const lines = [
    "よし。神託が降りた。",
    "迷うな。これが縁だ。",
    "今日はこれでいけ。",
    "運命の散歩、始めよ。",
    "ふむ…これで良い。"
  ];
  const hints = [
    what.needSearch ? "必要なら検索してよい" : "今日は検索なしでよい",
    where.isTrain ? "電車を使ってよい" : "徒歩でよい",
    what.timeRisk === "high" ? "無理はするな（外観だけでも可）" : "気軽に行け"
  ];
  oracleSay(pickOne(lines), pickOne(hints));
  toast(kind === "reroll" ? "引き直し" : "神託！");
  setTab("now");
}

/** デカ文字切替 */
function setBig(on){
  document.body.classList.toggle("bigText", on);
  $btnBig.textContent = on ? "デカ文字ON" : "デカ文字";
  saveBig(on);
  toast(on ? "デカ文字ON" : "デカ文字OFF");
}

/** events */
$("btnRoll").addEventListener("click", () => roll("roll"));
$("btnReroll").addEventListener("click", () => roll("reroll"));
$("navRoll").addEventListener("click", () => roll("roll"));
$("navToHistory").addEventListener("click", () => setTab("history"));
$tabNow.addEventListener("click", () => setTab("now"));
$tabHistory.addEventListener("click", () => setTab("history"));

$("btnClear").addEventListener("click", () => {
  if(!confirm("履歴を全削除します。よろしいですか？")) return;
  history = [];
  saveHistory(history);
  renderHistory();
  $result.textContent = "履歴を削除しました。「お題を引く」を押してください。";
  $chips.innerHTML = "";
  oracleSay("清めた。", "また引け");
  revealResult();
  toast("削除");
});

$btnBig.addEventListener("click", () => setBig(!document.body.classList.contains("bigText")));

/** init */
renderHistory();
setTab("now");
setBig(loadBig());
</script>
</body>
</html>
